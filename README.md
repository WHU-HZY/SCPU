# <center>A Possible Implementation of SCPU </center>

<center>WHU-HZY</center>



### 单周期处理器总体设计

我们的RISC_V单周期CPU直接照着书本的定义设计，CPU包括控制器（Ctrl）、PC(程序计数器)、RF(寄存器文件)、EXT(立即数产生器)、ALU(运算单元)等模块组成，并与外界的主存储器相连。

根据模板，PC、EXT、ALU、NPC、RF、Ctrl模块在SCPU.v中综合连接； DM和IM则在sccomp.v中与CPU相连。



### PC (程序计数器)

**3.2.1 功能描述**

​	本模块是控制pc值的功能单元。每经过一个clk上升沿将输入的NPC数据赋PC进行输出。此外，该模块带有复位信号。

**3.2.2 模块接口**

| 信号名 | 方向   | 位宽 | 描述                                    |
| ------ | ------ | ---- | --------------------------------------- |
| clk    | input  | 1    | 时钟信号                                |
| rst    | input  | 1    | 复位信号                                |
| NPC    | input  | 32   | 要更新的pc值，下一个clk上升沿用此更新pc |
| PC     | output | 32   | 当前pc值，输出给IM                      |



### NPC (指令地址更新器)

**3.3.1 功能描述**

​	由当前PC和立即数，计算出下一指令地址。没有跳转时，默认（PC+4）；否则根据选择信号NPCOp选择计算的跳转地址或运算器结果。

**3.3.2 模块接口**

| 信号名 | 方向   | 位宽 | 描述                         |
| ------ | ------ | ---- | ---------------------------- |
| PC     | input  | 32   | 当前pc值，用于计算新PC       |
| IMM    | input  | 32   | 立即数，用于计算新PC         |
| aluout | input  | 32   | 运算单元输出，备选的跳转位置 |
| NPCOp  | Input  | 3    | 控制信号，控制NPC的计算      |
| NPC    | output | 32   | 要更新的pc值，送往PC模块     |



### RF (寄存器文件)

**3.4.1 功能描述**

​	一共有32个寄存器。在时钟上升沿和复位上升沿时，通过always块对所有寄存器进行初始化（将所有寄存器清零）。

在时钟下降沿时，如果RFWr为1（写信号信号为真），则根据A3的值（寄存器地址）将WD的值（写入的数据）写入相应的寄存器中。

RD1和RD2根据A1和A2的值（读寄存器的地址）从相应的寄存器中读取数据，如果A1和A2为0，则输出0。

**3.4.2 模块接口**

| 信号名 | 方向   | 位宽 | 描述                        |
| ------ | ------ | ---- | --------------------------- |
| clk    | input  | 1    | 时钟信号                    |
| rst    | input  | 1    | 重置信号                    |
| RFWr   | input  | 1    | 写寄存器使能信号            |
| A1     | input  | 5    | rs1寄存器的地址             |
| A2     | input  | 5    | rs2寄存器的地址             |
| A3     | input  | 5    | rd寄存器的地址              |
| WD     | input  | 31   | 当写入寄存器堆的数据        |
| pc     | input  | 31   | 当前pc值                    |
| RD1    | output | 31   | 输出从寄存器堆中读出的数据1 |



### Ctrl (控制器单元)

**3.5.1 功能描述**

本模块主要负责对指令译码，并且发出为完成每条指令所要执行的各个操作的控制信号。

**3.5.2 模块接口**

| 信号名   | 方向   | 位宽 | 描述                          |
| -------- | ------ | ---- | ----------------------------- |
| Op       | input  | 7    | 输入指令                      |
| Funct3   | input  | 3    | Funct3                        |
| Funct7   | input  | 7    | Funct7                        |
| Zero     | input  | 1    | 运算单元输出是否为0           |
| MemRead  | output | 1    | 读取内存信号                  |
| RegWrite | output | 1    | 寄存器写信号                  |
| MemWrite | output | 1    | 数据存储器写信号              |
| EXTOp    | output | 6    | 立即数扩展信号                |
| ALUOp    | output | 5    | ALU控制信号                   |
| NPCOp    | output | 3    | 选择下一个PC的来源            |
| ALUSrc   | output | 1    | ALU源操作数A的来源选择        |
| DMType   | output | 3    | 访存类型（用于生成wea和扩展） |
| GPRSel   | output | 2    | 空置备用                      |
| WDSel    | output | 2    | 写回数据选择信号              |



### EXT (立即数扩展器)

**3.6.1 功能描述**

​	根据当前指令的类型，对输入立即数进行扩展。

**3.6.2 模块接口**

| 信号名     | 方向   | 位宽 | 描述              |
| ---------- | ------ | ---- | ----------------- |
| iimm_shamt | input  | 5    | I型移位指令立即数 |
| iimm       | input  | 12   | 其它I型指令立即数 |
| simm       | input  | 12   | S型指令立即数     |
| bimm       | input  | 12   | B型指令立即数     |
| uimm       | input  | 20   | 其它I型指令立即数 |
| jimm       | input  | 20   | UJ型指令立即数    |
| EXTOp      | input  | 6    | 扩展操作码        |
| immoutD    | output | 32   | 扩展后的结果      |



### ALU(运算单元)

**3.7.1 功能描述**

​	执行运算。C=A ALUOp B

**3.7.2 模块接口**

| 信号名 | 方向   | 位宽 | 描述               |
| ------ | ------ | ---- | ------------------ |
| A      | input  | 1    | 运算数1            |
| B      | input  | 1    | 运算数2            |
| ALUOp  | input  | 5    | 操作码             |
| PC     | input  | 32   | 当前地址，用于调试 |
| C      | output | 32   | 结果               |
| Zero   | output | 1    | 结果是否为0        |
